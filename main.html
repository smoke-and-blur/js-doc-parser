<!DOCTYPE html>

<script crossorigin src="https://unpkg.com/jszip/dist/jszip.min.js"></script>

<script src="https://volodymyrbaydalka.github.io/docxjs/dist/docx-preview.js"></script>

<style>
    #output {
        visibility: hidden;
    }

    #primary * {
        font-size: 18px;
    }

    #filter {
        height: 18px;
        width: 18px;
    }
</style>

<div id="primary">
    <form>
        <input type="file" id="f">
    </form>

    <label for="filter">18+</label>
    <input id="filter" type="checkbox">

    <noscript>Увага, JavaScript не увімкнено!</noscript>

    <p id="status"></p>

    <p id="result"></p>
</div>

<p id="output"></p>

<script>
    textFromCell = function (row, n) {
        const cell = row.children[n]
        const paragraph = cell.children[0]
        const run = paragraph.children[0]
        if (run.children.length < 1) {
            return ""
        }
        const text = run.children[0]
        const t = text.text.trim()
        return t
    }

    const docxOptions = Object.assign(
        docx.defaultOptions,
        {
            debug: true,
            experimental: true,
            hideWrapperOnPrint: true
        }
    );

    const fileInput = document.getElementById("f");
    const container = document.getElementById("output")
    const result = document.getElementById("result")
    const filter = document.getElementById("filter")
    const status = document.getElementById("status")

    fileInput.addEventListener(
        "change",
        async function (e) {
            status.innerText = ""
            var total = 0
            const m = new Map();
            let docxBlob = e.target.files[0]
            status.innerText = `loading document...`

            try {
                let res = await docx.renderAsync(docxBlob, container, null, docxOptions)

                status.innerText += ` document loaded...`

                res.documentPart.body.children.forEach(toplevel => {
                    if (toplevel.type !== "table") {
                        return
                    }

                    status.innerText += ` found table, parsing...`

                    var rows = toplevel.children.slice(1)

                    // row -> paragraph -> run -> text
                    rows.forEach(row => {
                        let timing = textFromCell(row, 5)

                        if (timing === "") {
                            return
                        }

                        const end = parseInt(timing.slice(0, 2))

                        if (filter.checked && end < 18) {
                            return
                        }

                        const t = textFromCell(row, 6)
                        let n = m.get(t)
                        if (n === undefined) {
                            n = 0
                        }
                        m.set(t, n + 1)
                        total++
                    })
                });
            } catch (error) {
                status.innerText += ` error: ${error}`
            }

            result.innerText = `Всього: ${total}\n`

            m.forEach(
                (value, key) => {
                    result.innerText += `${key}: ${value}\n`
                }
            )

        }
    );

</script>
