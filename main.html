<!DOCTYPE html>

<script crossorigin src="https://unpkg.com/jszip/dist/jszip.min.js"></script>

<script src="https://volodymyrbaydalka.github.io/docxjs/dist/docx-preview.js"></script>

<style>
    #output {
        visibility: hidden;
    }
</style>

<form>
    <input type="file" id="f">
</form>

<label for="filter">18+</label>
<input id="filter" type="checkbox">

<p id="result"></p>

<p id="output"></p>

<script>
    textFromCell = function (row, n) {
        const cell = row.children[n]
        const paragraph = cell.children[0]
        const run = paragraph.children[0]
        const text = run.children[0]
        const t = text.text.trim()
        return t
    }

    const docxOptions = Object.assign(
        docx.defaultOptions,
        {
            debug: true,
            experimental: true,
            hideWrapperOnPrint: true
        }
    );

    const fileInput = document.getElementById("f");
    const container = document.getElementById("output")
    const result = document.getElementById("result")
    const filter = document.getElementById("filter")

    fileInput.addEventListener(
        "change",
        async function (e) {
            var total = 0
            const m = new Map();
            let docxBlob = e.target.files[0]
            let res = await docx.renderAsync(docxBlob, container, null, docxOptions)

            res.documentPart.body.children.forEach(toplevel => {
                if (toplevel.type !== "table") {
                    return
                }

                var rows = toplevel.children.slice(1)

                // row -> paragraph -> run -> text
                rows.forEach(row => {
                    const end = parseInt(textFromCell(row, 5).slice(0, 2))

                    if (filter.checked && end < 18) {
                        return
                    }

                    const t = textFromCell(row, 6)
                    let n = m.get(t)
                    if (n === undefined) {
                        n = 0
                    }
                    m.set(t, n + 1)
                    total++
                })
            });

            result.innerText = `Всього: ${total}\n`

            m.forEach(
                (value, key) => {
                    result.innerText += `${key}: ${value}\n`
                }
            )

        }
    );

</script>
